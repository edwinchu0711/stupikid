name: Add New Message

# è§¸ç™¼æ¢ä»¶ï¼šç•¶æœ‰æ–°çš„ Issue è¢«å»ºç«‹æ™‚
on:
issues:
  types: [opened]

jobs:
add-message:
  runs-on: ubuntu-latest
  
  # åªè™•ç†å¸¶æœ‰ç‰¹å®šæ¨™ç±¤çš„ Issue
  if: contains(github.event.issue.labels.*.name, 'guestbook-message')
  
  steps:
  - name: Checkout repository
    uses: actions/checkout@v3
    with:
      token: ${{ secrets.GITHUB_TOKEN }}
  
  - name: Setup Node.js
    uses: actions/setup-node@v3
    with:
      node-version: '18'
  
  - name: Parse issue and add message
    run: |
      # å®‰è£ jq ä¾†è™•ç† JSON
      sudo apt-get update
      sudo apt-get install -y jq
      
      # å¾ Issue å…§å®¹ä¸­æå–è³‡è¨Š
      ISSUE_BODY="${{ github.event.issue.body }}"
      ISSUE_TITLE="${{ github.event.issue.title }}"
      ISSUE_USER="${{ github.event.issue.user.login }}"
      ISSUE_DATE="${{ github.event.issue.created_at }}"
      
      # è§£æ Issue å…§å®¹ (å‡è¨­ä½¿ç”¨ç‰¹å®šæ ¼å¼)
      NAME=$(echo "$ISSUE_BODY" | grep "å§“å:" | sed 's/å§“å://g' | xargs)
      EMAIL=$(echo "$ISSUE_BODY" | grep "Email:" | sed 's/Email://g' | xargs)
      MESSAGE=$(echo "$ISSUE_BODY" | grep -A 999 "ç•™è¨€å…§å®¹:" | tail -n +2)
      
      # å¦‚æœæ²’æœ‰æä¾›å§“åï¼Œä½¿ç”¨ GitHub ç”¨æˆ¶å
      if [ -z "$NAME" ]; then
        NAME="$ISSUE_USER"
      fi
      
      # è®€å–ç¾æœ‰çš„ç•™è¨€è³‡æ–™
      MESSAGES_FILE="data/messages.json"
      
      # ç²å–ä¸‹ä¸€å€‹ ID
      LAST_ID=$(jq '.lastId' $MESSAGES_FILE)
      NEW_ID=$((LAST_ID + 1))
      
      # å»ºç«‹æ–°ç•™è¨€ç‰©ä»¶
      NEW_MESSAGE=$(jq -n \
        --arg id "$NEW_ID" \
        --arg name "$NAME" \
        --arg email "$EMAIL" \
        --arg message "$MESSAGE" \
        --arg timestamp "$ISSUE_DATE" \
        --arg github_user "$ISSUE_USER" \
        --arg issue_number "${{ github.event.issue.number }}" \
        '{
          id: ($id | tonumber),
          name: $name,
          email: $email,
          message: $message,
          timestamp: $timestamp,
          github_user: $github_user,
          issue_number: ($issue_number | tonumber),
          approved: true
        }')
      
      # å°‡æ–°ç•™è¨€æ·»åŠ åˆ° JSON æª”æ¡ˆ
      jq --argjson new_message "$NEW_MESSAGE" \
         --arg new_id "$NEW_ID" \
         '.messages += [$new_message] | .lastId = ($new_id | tonumber)' \
         $MESSAGES_FILE > temp.json && mv temp.json $MESSAGES_FILE
      
      echo "å·²æ·»åŠ æ–°ç•™è¨€: $NAME"
  
  - name: Commit and push changes
    run: |
      git config --local user.email "action@github.com"
      git config --local user.name "GitHub Action"
      git add data/messages.json
      git commit -m "Add new message from ${{ github.event.issue.user.login }}" || exit 0
      git push
  
  - name: Close issue with thank you message
    uses: actions/github-script@v6
    with:
      script: |
        github.rest.issues.createComment({
          issue_number: context.issue.number,
          owner: context.repo.owner,
          repo: context.repo.repo,
          body: 'ğŸ‰ æ„Ÿè¬ä½ çš„ç•™è¨€ï¼ä½ çš„ç•™è¨€å·²ç¶“æˆåŠŸæ·»åŠ åˆ°ç•™è¨€æ¿ä¸­ã€‚\n\nä½ å¯ä»¥åœ¨ [ç•™è¨€æ¿é é¢](https://ä½ çš„ç”¨æˆ¶å.github.io/ä½ çš„å€‰åº«å/) æŸ¥çœ‹ä½ çš„ç•™è¨€ã€‚'
        });
        
        github.rest.issues.update({
          issue_number: context.issue.number,
          owner: context.repo.owner,
          repo: context.repo.repo,
          state: 'closed'
        });
